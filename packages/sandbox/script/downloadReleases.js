// @ts-check

// Ensure the versions dropdown is up to date
const axios = require("axios").default
const { writeFileSync } = require("fs")
const { join } = require("path")
const { format } = require("prettier")

const go = async () => {
  const response = await axios({ url: "https://typescript.azureedge.net/indexes/releases.json" })
  const versions = response.data.versions.reverse()

  // Get the highest maj/min ignoring patch versions
  const latestMajMin = new Map()
  versions.forEach(v => {
    const majMin = v.split(".")[0] + "." + v.split(".")[1]
    if (!latestMajMin.has(majMin)) {
      latestMajMin.set(majMin, v)
    }
  })
  const supportedVersions = [...latestMajMin.values()]

  const code = `// This is auto-generated by scripts/downloadReleases.js
/** Every prod version **/
export const allReleases = ["${versions.join('", "')}"] as const

/** The latest major.min version **/
export const supportedReleases = ["${supportedVersions.join('", "')}"] as const

/** A type of all versions **/
export type ReleaseVersions = "${versions.join('" | "')}"
`
  const path = join(__dirname, "..", "src", "releases.ts")
  writeFileSync(path, format(code, { filepath: path }), "utf8")

  const jsonPath = join(__dirname, "..", "src", "releases.json")
  writeFileSync(jsonPath, format(JSON.stringify(response.data), { filepath: jsonPath }), "utf8")
  console.log("Updated the releases with the versions created by make-monaco-builds")
}

go()
